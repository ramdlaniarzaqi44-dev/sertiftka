<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Mapel Pilihan Penunjang Universitas (Pro V4 - Responsive UI)</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --background: #f8fafc;
            --card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #475569;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background);
            color: var(--text-main);
            line-height: 1.6;
            padding: 15px;
            font-size: 16px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 90vh;
            position: relative;
        }

        /* HEADER DYNAMIC */
        header {
            background: linear-gradient(135deg, var(--primary), #1e40af);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        header h1 { 
            font-size: clamp(1.5rem, 4vw, 2.2rem); 
            margin-bottom: 8px; 
            font-weight: 800; 
            position: relative;
        }
        
        header p { 
            opacity: 0.95; 
            font-size: clamp(0.9rem, 3vw, 1.1rem); 
            max-width: 600px; 
            margin: 0 auto; 
            position: relative;
        }

        /* PROGRESS BAR */
        .progress-container { background: #e2e8f0; height: 6px; width: 100%; }
        .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* SECTIONS & ANIMATIONS */
        .step-content { 
            padding: 30px; 
            display: none; 
            flex-grow: 1;
        }
        
        .step-content.active { 
            display: block; 
            animation: fadeInScale 0.4s ease-out; 
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        h2 { 
            color: var(--primary); 
            margin-bottom: 25px; 
            font-size: clamp(1.3rem, 3vw, 1.8rem); 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 15px; 
        }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 20px; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: var(--text-main); 
            font-size: 0.95rem; 
        }
        
        select, input[type="number"] { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid #cbd5e1; 
            border-radius: 8px; 
            font-size: 1rem; 
            transition: all 0.2s; 
            background: #f8fafc;
            appearance: none; /* Hilangkan style default browser */
        }

        select:focus, input:focus { 
            outline: none; 
            border-color: var(--primary); 
            background: #fff;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); 
        }

        /* GRID SYSTEM (Responsive) */
        .input-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 20px; 
        }

        .result-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr; 
            gap: 25px; 
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .step-content { padding: 20px; }
            .input-grid { grid-template-columns: 1fr; gap: 15px; } /* 1 Kolom di HP */
            .result-grid { grid-template-columns: 1fr; }
            
            /* Tombol full width di HP */
            .btn-group { flex-direction: column-reverse; gap: 12px; }
            button { width: 100%; padding: 16px; }
            
            .likert-scale { gap: 5px; }
            .likert-option { width: auto; flex: 1; }
            .likert-option input { width: 25px; height: 25px; } /* Target sentuh lebih besar */
        }

        /* QUESTION CARDS */
        .question-item { 
            background: #fff; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 10px; 
            border: 1px solid #e2e8f0; 
            transition: transform 0.2s, border-color 0.2s; 
        }
        
        .question-item:hover { 
            border-color: var(--primary); 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .likert-scale { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 1px dashed #e2e8f0; 
        }

        .likert-option { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            position: relative; 
        }
        
        .likert-option input { 
            margin-bottom: 5px; 
            cursor: pointer; 
            accent-color: var(--primary);
        }

        .scroll-area { 
            max-height: 60vh; 
            overflow-y: auto; 
            padding: 10px; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            background: #f8fafc; 
        }

        /* BUTTONS */
        .btn-group { 
            margin-top: 30px; 
            display: flex; 
            justify-content: space-between; 
        }
        
        button { 
            padding: 14px 30px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-next { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); 
        }
        
        .btn-next:hover { 
            background: var(--primary-dark); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.4); 
        }
        
        .btn-prev { 
            background: var(--secondary); 
            color: white; 
        }
        
        .btn-prev:hover { 
            background: #475569; 
        }

        /* RESULT CARDS */
        .result-card { 
            background: white; 
            border: 1px solid #e2e8f0; 
            padding: 25px; 
            border-radius: 12px; 
            height: 100%; 
        }

        .mapel-item { 
            background: #f8fafc; 
            padding: 16px; 
            margin-bottom: 12px; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 5px solid #cbd5e1; 
            transition: all 0.2s;
        }

        .mapel-item:hover { transform: translateX(5px); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            white-space: nowrap; 
            margin-left: 10px;
        }

        .badge-both { background: #fce7f3; color: #be185d; }
        .badge-mandatory { background: #fee2e2; color: #b91c1c; }
        .badge-supporting { background: #dbeafe; color: #1d4ed8; }

        .psych-insight { 
            background: #fffbeb; 
            border-left: 5px solid var(--warning); 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 25px; 
            font-size: 0.95rem; 
            line-height: 1.7; 
        }

        /* VALIDITY METER */
        .validity-box { 
            text-align: center; 
            padding: 30px; 
            border-radius: 16px; 
            border: 2px solid #e2e8f0; 
            margin-bottom: 20px; 
            background: #fff; 
            transition: all 0.5s ease;
        }
        
        .validity-score { 
            font-size: 3.5rem; 
            font-weight: 900; 
            line-height: 1; 
            margin-bottom: 5px; 
        }
        
        .validity-label { 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            font-weight: 700; 
            color: var(--text-sub); 
        }

        footer { 
            text-align: center; 
            padding: 20px; 
            color: var(--text-sub); 
            font-size: 0.9rem; 
            border-top: 1px solid #e2e8f0; 
            background: #f1f5f9; 
            margin-top: auto; 
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Navigator Mapel & Jurusan</h1>
        <p>Analisis Cerdas: Aturan SNBP & Psikometrik RIASEC</p>
    </header>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="mainForm" onsubmit="event.preventDefault();">
        
        <!-- STEP 1: Tujuan Karir -->
        <div class="step-content active" id="step1">
            <h2>Langkah 1: Target Studi (Plan A & B)</h2>
            <p>Pilih jurusan secara spesifik agar sistem bisa menghitung peluang dengan presisi.</p>
            
            <div class="input-grid">
                <div class="form-group" style="background: #eff6ff; padding: 20px; border-radius: 10px; border: 1px solid #bfdbfe;">
                    <label style="color: #1e40af;">üéØ Pilihan 1 (Prioritas Utama):</label>
                    <select id="targetMajor1" required class="major-select">
                        <option value="" disabled selected>-- Pilih Target Utama --</option>
                    </select>
                </div>

                <div class="form-group" style="background: #f5f3ff; padding: 20px; border-radius: 10px; border: 1px solid #ddd6fe;">
                    <label style="color: #5b21b6;">üõ°Ô∏è Pilihan 2 (Rencana Cadangan):</label>
                    <select id="targetMajor2" required class="major-select">
                        <option value="" disabled selected>-- Pilih Target Cadangan --</option>
                    </select>
                </div>
            </div>

            <div style="margin-top:20px; padding:15px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0; font-size:0.9rem; color:#166534;">
                <strong>‚ÑπÔ∏è Catatan Update:</strong> Daftar jurusan mencakup <b>Ilmu Komunikasi, Hubungan Internasional, Pertanian, Kesehatan Masyarakat, dan Pendidikan</b>.
            </div>

            <div class="btn-group">
                <button class="btn-next" onclick="nextStep(1)">Lanjut: Input Nilai &rsaquo;</button>
            </div>
        </div>

        <!-- STEP 2: Input Akademik -->
        <div class="step-content" id="step2">
            <h2>Langkah 2: Validasi Akademik</h2>
            <p>Masukkan nilai spesifik mata pelajaran (0-100) dari Rapor Kelas 10.</p>

            <div class="input-grid">
                <!-- Mapel Umum -->
                <div class="form-group">
                    <label>Matematika Umum</label>
                    <input type="number" id="score_mtk" min="0" max="100" placeholder="0-100" required>
                </div>
                <div class="form-group">
                    <label>Bahasa Inggris</label>
                    <input type="number" id="score_bing" min="0" max="100" placeholder="0-100" required>
                </div>
                <div class="form-group">
                    <label>Bahasa Indonesia</label>
                    <input type="number" id="score_indo" min="0" max="100" placeholder="0-100" required>
                </div>
                <div class="form-group">
                    <label>Informatika</label>
                    <input type="number" id="score_info" min="0" max="100" placeholder="0-100">
                </div>
                
                <!-- Rumpun IPA -->
                <div class="form-group">
                    <label>Fisika</label>
                    <input type="number" id="score_fis" min="0" max="100" placeholder="Nilai Fisika" required>
                </div>
                <div class="form-group">
                    <label>Kimia</label>
                    <input type="number" id="score_kim" min="0" max="100" placeholder="Nilai Kimia" required>
                </div>
                <div class="form-group">
                    <label>Biologi</label>
                    <input type="number" id="score_bio" min="0" max="100" placeholder="Nilai Biologi" required>
                </div>

                <!-- Rumpun IPS -->
                <div class="form-group">
                    <label>Ekonomi</label>
                    <input type="number" id="score_eko" min="0" max="100" placeholder="Nilai Ekonomi" required>
                </div>
                <div class="form-group">
                    <label>Sosiologi</label>
                    <input type="number" id="score_sos" min="0" max="100" placeholder="Nilai Sosiologi" required>
                </div>
                <div class="form-group">
                    <label>Geografi</label>
                    <input type="number" id="score_geo" min="0" max="100" placeholder="Nilai Geografi" required>
                </div>
                <div class="form-group">
                    <label>Sejarah</label>
                    <input type="number" id="score_sej" min="0" max="100" placeholder="Nilai Sejarah" required>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-prev" onclick="prevStep(2)">&lsaquo; Kembali</button>
                <button class="btn-next" onclick="nextStep(2)">Lanjut: Tes Minat &rsaquo;</button>
            </div>
        </div>

        <!-- STEP 3: Validasi Minat (RIASEC) -->
        <div class="step-content" id="step3">
            <h2>Langkah 3: Asesmen Minat (48 Soal)</h2>
            <p>Jawablah dengan jujur (1-5). Pertanyaan ini memetakan tipe kepribadianmu.</p>
            
            <div class="scroll-area">
                <div id="dynamicQuestions"></div>
            </div>

            <div class="btn-group">
                <button class="btn-prev" onclick="prevStep(3)">&lsaquo; Kembali</button>
                <button class="btn-next" onclick="calculateResult()">‚ú® Analisis Hasil</button>
            </div>
        </div>

        <!-- STEP 4: Hasil -->
        <div class="step-content" id="step4">
            <h2 style="text-align: center; border:none; margin-bottom:20px;">Laporan Analisis Studi</h2>

            <div class="result-grid">
                <!-- Kolom Kiri: Daftar Mapel -->
                <div class="result-card">
                    <h3 style="margin-bottom: 20px; color: var(--primary); display:flex; align-items:center; gap:10px;">
                        <span>üìã</span> 5 Rekomendasi Mapel
                    </h3>
                    <ul id="finalList" style="list-style:none; padding:0;"></ul>
                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 15px; font-style: italic;">
                        *Disusun berdasarkan Permendikbudristek No. 345/M/2022.
                    </div>
                </div>

                <!-- Kolom Kanan: Meteran Validitas -->
                <div>
                    <div id="validityBox" class="validity-box">
                        <div class="validity-score" id="validityScoreText">0%</div>
                        <div class="validity-label">Skor Validitas</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; color: #555;">(Kecocokan Akademik & Minat)</div>
                    </div>
                    
                    <div class="result-card">
                        <h4 style="margin-bottom:10px; font-size:0.95rem; color:#64748b;">Kode RIASEC:</h4>
                        <div id="riasecScores" style="font-family: monospace; font-weight:bold; font-size:1.2rem; color: var(--text-main);"></div>
                    </div>
                </div>
            </div>

            <div class="psych-insight" id="finalPsychAnalysis"></div>
            
            <div class="btn-group">
                <button class="btn-prev" onclick="location.reload()">‚Ü∫ Mulai Ulang</button>
                <button class="btn-next" onclick="window.print()">üñ®Ô∏è Cetak PDF</button>
            </div>
        </div>

    </form>
    
    <footer>
        &copy; Aplikasi ini adalah buatan dari <strong>Pak Ndutz BK Al-Multazam</strong>.
    </footer>
</div>

<script>
    // --- 1. DATA MASTER JURUSAN & ATURAN SNBP ---
    const majorsData = {
        'kedokteran': { name: 'Kedokteran / Dokter Gigi / Veteriner', req: ['biologi', 'kimia'], riasec: ['I', 'S', 'R'] },
        'kesmas_farmasi': { name: 'Kesehatan Masy. / Farmasi / Gizi / Keperawatan', req: ['biologi', 'kimia'], riasec: ['S', 'I', 'C'] },
        'teknik_fisika': { name: 'Teknik (Sipil, Mesin, Elektro, Fisika, Penerbangan)', req: ['fisika', 'mtk_lanjut'], riasec: ['R', 'I', 'C'] },
        'teknik_kimia': { name: 'Teknik Kimia / Lingkungan / Metalurgi', req: ['kimia', 'fisika', 'mtk_lanjut'], riasec: ['I', 'R'] },
        'informatika': { name: 'Informatika / Ilmu Komputer / Sistem Informasi', req: ['mtk_lanjut', 'informatika'], riasec: ['I', 'C', 'R'] },
        'mipa_fis': { name: 'MIPA (Matematika / Fisika / Statistika)', req: ['mtk_lanjut', 'fisika'], riasec: ['I', 'C'] },
        'mipa_bio': { name: 'MIPA (Biologi / Kimia)', req: ['biologi', 'kimia'], riasec: ['I'] },
        'pertanian': { name: 'Pertanian / Agroteknologi / Kehutanan', req: ['biologi'], riasec: ['R', 'I', 'E'] },
        'ekonomi': { name: 'Ekonomi / Pembangunan / Bisnis', req: ['ekonomi', 'mtk_lanjut'], riasec: ['E', 'C', 'S'] },
        'akuntansi': { name: 'Akuntansi / Manajemen Keuangan', req: ['ekonomi', 'mtk_lanjut'], riasec: ['C', 'E'] },
        'komunikasi': { name: 'Ilmu Komunikasi / Hubungan Masyarakat / Jurnalistik', req: ['sosiologi', 'bing_lanjut'], riasec: ['A', 'E', 'S'] },
        'hi_hukum': { name: 'Hukum / Hubungan Internasional / Ilmu Politik', req: ['sosiologi', 'bing_lanjut'], riasec: ['E', 'S', 'I'] },
        'psikologi': { name: 'Psikologi', req: ['sosiologi', 'biologi', 'mtk_lanjut'], riasec: ['S', 'I', 'A'] },
        'sastra': { name: 'Sastra (Inggris/Indonesia/Asing) / Ilmu Budaya', req: ['bing_lanjut', 'sosiologi'], riasec: ['A', 'S', 'I'] },
        'pendidikan': { name: 'Pendidikan / Keguruan (Semua Mapel)', req: ['sosiologi', 'bing_lanjut'], riasec: ['S', 'A', 'E'] },
        'dkv': { name: 'Desain Komunikasi Visual / Seni Rupa / Arsitektur', req: ['informatika', 'bing_lanjut'], riasec: ['A', 'R', 'I'] }
    };

    // --- 2. DATABASE MAPEL SEKOLAH ---
    const subjectsDB = [
        { id: 'mtk_lanjut', name: 'Matematika Tkt. Lanjut', riasec: ['I', 'C'], inputKey: 'score_mtk' },
        { id: 'fisika', name: 'Fisika', riasec: ['R', 'I'], inputKey: 'score_fis' },
        { id: 'kimia', name: 'Kimia', riasec: ['I', 'R'], inputKey: 'score_kim' },
        { id: 'biologi', name: 'Biologi', riasec: ['I', 'S'], inputKey: 'score_bio' },
        { id: 'informatika', name: 'Informatika', riasec: ['C', 'I', 'R'], inputKey: 'score_info' },
        { id: 'ekonomi', name: 'Ekonomi', riasec: ['E', 'C'], inputKey: 'score_eko' },
        { id: 'sosiologi', name: 'Sosiologi', riasec: ['S', 'E', 'A'], inputKey: 'score_sos' },
        { id: 'geografi', name: 'Geografi', riasec: ['R', 'I', 'S'], inputKey: 'score_geo' },
        { id: 'bing_lanjut', name: 'B. Inggris Tkt. Lanjut', riasec: ['A', 'S', 'E'], inputKey: 'score_bing' },
        { id: 'sejarah', name: 'Sejarah Tkt. Lanjut', riasec: ['S', 'I', 'A'], inputKey: 'score_sej' }
    ];

    // --- 3. 48 RIASEC QUESTIONS ---
    const psychQuestions = [
        { t: 'R', q: 'Memperbaiki alat elektronik/mesin.' }, { t: 'R', q: 'Bekerja fisik di luar ruangan.' },
        { t: 'R', q: 'Merakit model bangunan/benda.' }, { t: 'R', q: 'Menggunakan perkakas (obeng/palu).' },
        { t: 'R', q: 'Mengurus tanaman atau hewan.' }, { t: 'R', q: 'Kegiatan olahraga/atletik.' },
        { t: 'R', q: 'Memahami cara kerja mesin mobil.' }, { t: 'R', q: 'Membuat kerajinan kayu/logam.' },
        { t: 'I', q: 'Memecahkan soal matematika rumit.' }, { t: 'I', q: 'Melakukan eksperimen sains.' },
        { t: 'I', q: 'Membaca artikel ilmiah/sains.' }, { t: 'I', q: 'Menganalisis grafik dan data.' },
        { t: 'I', q: 'Bermain game strategi/logika.' }, { t: 'I', q: 'Belajar tentang alam semesta.' },
        { t: 'I', q: 'Riset penyebab suatu masalah.' }, { t: 'I', q: 'Meneliti fakta sejarah secara detail.' },
        { t: 'A', q: 'Menggambar, melukis, desain grafis.' }, { t: 'A', q: 'Menulis cerpen, puisi, atau naskah.' },
        { t: 'A', q: 'Bermain musik atau bernyanyi.' }, { t: 'A', q: 'Merancang pakaian atau fashion.' },
        { t: 'A', q: 'Menonton pertunjukan seni/teater.' }, { t: 'A', q: 'Tampil unik dan berbeda dari orang lain.' },
        { t: 'A', q: 'Membuat konten video/fotografi.' }, { t: 'A', q: 'Mendekorasi ruangan agar estetik.' },
        { t: 'S', q: 'Mengajar atau membimbing teman.' }, { t: 'S', q: 'Mendengarkan curhat masalah orang lain.' },
        { t: 'S', q: 'Bekerja dalam tim/kelompok.' }, { t: 'S', q: 'Melakukan kegiatan amal/sosial.' },
        { t: 'S', q: 'Mempelajari psikologi manusia.' }, { t: 'S', q: 'Merawat orang sakit.' },
        { t: 'S', q: 'Menengahi pertengkaran teman.' }, { t: 'S', q: 'Bertemu dan ngobrol dengan orang baru.' },
        { t: 'E', q: 'Berjualan produk atau bisnis.' }, { t: 'E', q: 'Berbicara/pidato di depan umum.' },
        { t: 'E', q: 'Menjadi pemimpin/ketua organisasi.' }, { t: 'E', q: 'Berdebat atau negosiasi.' },
        { t: 'E', q: 'Mengelola sebuah acara (event).' }, { t: 'E', q: 'Mempelajari pasar saham/ekonomi.' },
        { t: 'E', q: 'Mengambil risiko untuk sukses.' }, { t: 'E', q: 'Bercita-cita menjadi manajer/CEO.' },
        { t: 'C', q: 'Membuat jadwal kegiatan teratur.' }, { t: 'C', q: 'Mengatur keuangan/pembukuan.' },
        { t: 'C', q: 'Input data ke Excel/Komputer.' }, { t: 'C', q: 'Mengikuti aturan yang jelas.' },
        { t: 'C', q: 'Menulis kode program (coding) rapi.' }, { t: 'C', q: 'Mengarsipkan dokumen.' },
        { t: 'C', q: 'Memeriksa detail kesalahan tulisan.' }, { t: 'C', q: 'Mengoleksi barang dengan urutan tertentu.' }
    ];

    psychQuestions.sort(() => Math.random() - 0.5);

    // --- STATE ---
    let userProfile = { major1: '', major2: '', scores: {}, riasecScores: {} };

    window.onload = function() {
        const sel1 = document.getElementById('targetMajor1');
        const sel2 = document.getElementById('targetMajor2');
        const sortedKeys = Object.keys(majorsData).sort((a,b) => majorsData[a].name.localeCompare(majorsData[b].name));
        sortedKeys.forEach(key => {
            const opt = `<option value="${key}">${majorsData[key].name}</option>`;
            sel1.innerHTML += opt;
            sel2.innerHTML += opt;
        });
    };

    // --- UI FUNCTIONS ---
    function updateProgress(step) {
        document.getElementById('progressBar').style.width = (step / 4) * 100 + '%';
    }

    function nextStep(step) {
        if (step === 1) {
            const m1 = document.getElementById('targetMajor1').value;
            const m2 = document.getElementById('targetMajor2').value;
            if (!m1 || !m2) { alert("Wajib pilih kedua jurusan!"); return; }
            if (m1 === m2) { if(!confirm("Jurusan Utama dan Cadangan sama. Yakin?")) return; }
            userProfile.major1 = m1; userProfile.major2 = m2;
            renderQuestions();
        }
        if (step === 2) {
            const inputs = document.querySelectorAll('#step2 input');
            let complete = true;
            inputs.forEach(inp => {
                if(inp.hasAttribute('required') && !inp.value) complete = false;
                userProfile.scores[inp.id] = parseInt(inp.value) || 0;
            });
            if(!complete) { alert("Mohon lengkapi semua nilai mapel wajib!"); return; }
        }
        
        // Animasi transisi antar tab
        const currentTab = document.querySelector('.step-content.active');
        const nextTab = document.getElementById(`step${step + 1}`);
        
        if(currentTab && nextTab) {
            currentTab.classList.remove('active');
            nextTab.classList.add('active');
            updateProgress(step + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function prevStep(step) {
        const currentTab = document.querySelector('.step-content.active');
        const prevTab = document.getElementById(`step${step - 1}`);
        
        if(currentTab && prevTab) {
            currentTab.classList.remove('active');
            prevTab.classList.add('active');
            updateProgress(step - 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function renderQuestions() {
        const container = document.getElementById('dynamicQuestions');
        if(container.innerHTML.trim() === '') {
            psychQuestions.forEach((q, idx) => {
                container.innerHTML += `
                    <div class="question-item">
                        <div style="font-weight:600; margin-bottom:10px;">${idx + 1}. ${q.q}</div>
                        <div class="likert-scale">
                            ${[1,2,3,4,5].map(val => `
                                <label class="likert-option">
                                    <input type="radio" name="q_${idx}" value="${val}" data-type="${q.t}" required>
                                    <span class="likert-label">${val}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
        }
    }

    // --- LOGIC ---
    function calculateResult() {
        const inputs = document.querySelectorAll('#step3 input:checked');
        if (inputs.length < psychQuestions.length) { alert("Mohon jawab semua 48 soal!"); return; }

        userProfile.riasecScores = { R:0, I:0, A:0, S:0, E:0, C:0 };
        inputs.forEach(inp => {
            userProfile.riasecScores[inp.getAttribute('data-type')] += parseInt(inp.value);
        });

        const normalize = (s) => (s / 40) * 100;

        subjectsDB.forEach(sub => {
            let academic = userProfile.scores[sub.inputKey] || 0;
            let interestRaw = 0;
            sub.riasec.forEach(type => { interestRaw += userProfile.riasecScores[type]; });
            let interestAvg = normalize(interestRaw / sub.riasec.length);

            sub.finalScore = (academic * 0.4) + (interestAvg * 0.6);
            sub.interestScore = interestAvg;
            sub.academicScore = academic;
        });

        const major1Data = majorsData[userProfile.major1];
        const major2Data = majorsData[userProfile.major2];
        const req1 = major1Data.req;
        const req2 = major2Data.req;
        
        let finalSelection = [];
        let remainingSubjects = [];

        subjectsDB.forEach(sub => {
            const isReq1 = req1.includes(sub.id);
            const isReq2 = req2.includes(sub.id);

            if (isReq1 && isReq2) {
                sub.status = 'Wajib Pilihan 1 & 2'; sub.priority = 1; sub.badgeClass = 'badge-both';
                finalSelection.push(sub);
            } else if (isReq1) {
                sub.status = 'Wajib Pilihan 1'; sub.priority = 2; sub.badgeClass = 'badge-mandatory';
                finalSelection.push(sub);
            } else if (isReq2) {
                sub.status = 'Wajib Pilihan 2'; sub.priority = 3; sub.badgeClass = 'badge-mandatory';
                finalSelection.push(sub);
            } else {
                sub.status = 'Pendukung Minat'; sub.priority = 4; sub.badgeClass = 'badge-supporting';
                remainingSubjects.push(sub);
            }
        });

        remainingSubjects.sort((a, b) => b.finalScore - a.finalScore);
        const slotsNeeded = 5 - finalSelection.length;
        if (slotsNeeded > 0) finalSelection = finalSelection.concat(remainingSubjects.slice(0, slotsNeeded));
        finalSelection.sort((a, b) => a.priority - b.priority);

        const validityResult = calculateDiagnosticValidity(major1Data);

        displayResults(finalSelection, validityResult);
        nextStep(3);
    }

    function calculateDiagnosticValidity(m1Data) {
        const userScores = userProfile.riasecScores;
        const expectedTraits = m1Data.riasec;
        let traitMatch = 0;
        let maxTraitMatch = expectedTraits.length * 40; 
        expectedTraits.forEach(t => { traitMatch += userScores[t]; });
        let psychScore = (traitMatch / maxTraitMatch) * 100;

        let academicPenalties = 0;
        let lowGradeSubjects = [];
        
        m1Data.req.forEach(reqId => {
            const subj = subjectsDB.find(s => s.id === reqId);
            const grade = userProfile.scores[subj.inputKey];
            if (grade < 75) {
                academicPenalties += 20; 
                lowGradeSubjects.push(subj.name);
            }
        });

        let finalVal = Math.round(psychScore - academicPenalties);
        if (finalVal < 0) finalVal = 0;
        if (finalVal > 100) finalVal = 100;

        return {
            score: finalVal,
            psychScore: psychScore,
            academicPenalties: academicPenalties,
            lowSubjects: lowGradeSubjects
        };
    }

    function displayResults(selection, diagnosis) {
        const list = document.getElementById('finalList');
        list.innerHTML = '';
        selection.forEach(sub => {
            list.innerHTML += `
                <li class="mapel-item" style="border-left-color: ${sub.finalScore > 75 ? '#10b981' : '#f59e0b'}">
                    <div>
                        <strong style="font-size:1.05rem;">${sub.name}</strong>
                        <div style="font-size:0.85rem; color:#64748b; margin-top:4px;">
                           Skor: ${Math.round(sub.finalScore)}% (Nilai: ${sub.academicScore} | Minat: ${Math.round(sub.interestScore)}%)
                        </div>
                    </div>
                    <span class="badge ${sub.badgeClass}">${sub.status}</span>
                </li>
            `;
        });

        const vBox = document.getElementById('validityBox');
        const vText = document.getElementById('validityScoreText');
        vText.innerText = diagnosis.score + '%';
        
        if(diagnosis.score >= 80) {
            vBox.style.borderColor = '#10b981'; vBox.style.background = '#f0fdf4'; vBox.style.color = '#166534';
        } else if (diagnosis.score >= 50) {
            vBox.style.borderColor = '#f59e0b'; vBox.style.background = '#fffbeb'; vBox.style.color = '#92400e';
        } else {
            vBox.style.borderColor = '#ef4444'; vBox.style.background = '#fef2f2'; vBox.style.color = '#991b1b';
        }

        const scores = userProfile.riasecScores;
        const traits = Object.keys(scores).sort((a,b) => scores[b] - scores[a]);
        const top3 = traits.slice(0, 3).join("-");
        document.getElementById('riasecScores').innerText = `Kode: ${top3}`;

        const analysisDiv = document.getElementById('finalPsychAnalysis');
        let msg = '';
        const m1Name = majorsData[userProfile.major1].name;

        if (diagnosis.score >= 80) {
            msg = `‚úÖ <b>Kondisi Ideal:</b><br>Profil kepribadianmu (${top3}) dan nilai akademikmu sangat selaras dengan tuntutan jurusan <b>${m1Name}</b>.`;
        } else if (diagnosis.psychScore >= 70 && diagnosis.academicPenalties > 0) {
            msg = `‚ö†Ô∏è <b>Minat Tinggi, Nilai Perlu Didorong:</b><br>Kepribadianmu COCOK, tapi nilai mapel wajib (${diagnosis.lowSubjects.join(", ")}) masih di bawah standar.`;
        } else if (diagnosis.psychScore < 60 && diagnosis.academicPenalties === 0) {
            msg = `‚ö†Ô∏è <b>Mampu tapi Risiko Bosan:</b><br>Nilai akademikmu masuk, tapi profil kepribadianmu (${top3}) kurang cocok dengan karakter jurusan ini.`;
        } else {
            msg = `‚õî <b>Mismatch (Risiko Tinggi):</b><br>Baik nilai maupun minat tampaknya kurang sesuai untuk jurusan <b>${m1Name}</b> saat ini.`;
        }

        analysisDiv.innerHTML = `<strong>Diagnosa Ahli:</strong><br>${msg}`;
    }
</script>

</body>
</html>
